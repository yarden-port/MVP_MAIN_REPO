name: CI
on:
  workflow_dispatch:
    inputs:
      environment:
        required: true
        default: staging
        description: "Environment to deploy service to"
        type: string
      port_payload:
        required: true
        description: "Port's payload, including details for who triggered the action and general context (blueprint, run id, etc...)"
        type: string
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: echo-deploy
        run: echo "deploy"

  report-deployment:
    name: Report new deployment Entity
    runs-on: ubuntu-latest
    steps:
      - name: Extract SHA short
        run: echo "SHA_SHORT=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
      - name: "Create new image"
        id: new-image
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          identifier: ${{ inputs.service }}-${{ inputs.environment }}-${{ env.SHA_SHORT }}
          blueprint: image
          properties: |
            {
               "title": "${{fromJson(inputs.port_payload).context.entity}}",
               "tags": "1",
               "image_branch": "master"
            }
          runId: "${{fromJson(inputs.port_payload).context.runId}}"
      - name: "Report deployment Entity to port ðŸš¢"
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          identifier: ${{ inputs.service }}-${{ inputs.environment }}-${{ env.SHA_SHORT }}
          blueprint: running_service
          properties: |
            {
               "syncStatus": "Synced",
               "healthStatus": "Healthy"
            }
          relations: |
            {
              "image": "${{ fromJson(steps.new-image.outputs.entity)}}",
              "environment":"${{ inputs.environment }}"

            }
          runId: "${{fromJson(inputs.port_payload).context.runId}}"

      - name: Set the production image
        id: set-dev
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: UPSERT
          identifier: ${{fromJson(github.event.inputs.port_payload).payload.entity.relations.prod_runtime }}
          blueprint: services
          runId: ${{ fromJson(github.event.inputs.port_payload).context.runId }}
          logMessage: "Updating the production image..."          
          relations: |
            {
              "image": "${{ fromJson(steps.get-staging.outputs.entity).relations.image }}"
            }
